<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>i2b2 Test</title>
<script type="text/javascript">
	var i2b2build = "2.0m";
</script>

<!-- js-i2b2 depends on this but doesn't include it -->
<script type="text/javascript" src="js-ext/yui/build/yahoo/yahoo.js" ></script>
<script type="text/javascript" src="js-ext/yui/build/event/event.js" ></script>
<script type="text/javascript" src="js-ext/yui/build/dom/dom.js"></script>
<script type="text/javascript" src="js-ext/yui/build/yuiloader/yuiloader.js"></script>
<script type="text/javascript" src="js-ext/yui/build/dragdrop/dragdrop.js" ></script>
<script type="text/javascript" src="js-ext/yui/build/element/element.js"></script>
<script type="text/javascript" src="js-ext/yui/build/container/container_core.js"></script>
<script type="text/javascript" src="js-ext/yui/build/container/container.js"></script>
<script type="text/javascript" src="js-ext/yui/build/resize/resize.js"></script>
<script type="text/javascript" src="js-ext/yui/build/utilities/utilities.js"></script>
<script type="text/javascript" src="js-ext/yui/build/menu/menu.js" ></script>
<script type="text/javascript" src="js-ext/yui/build/calendar/calendar.js"></script>
<script type="text/javascript" src="js-ext/yui/build/treeview/treeview.js" ></script>
<script type="text/javascript" src="js-ext/yui/build/tabview/tabview.js"></script>
<script type="text/javascript" src="js-ext/yui/build/animation/animation.js"></script>
<script type="text/javascript" src="js-ext/yui/build/datasource/datasource.js"></script>
<script type="text/javascript" src="js-ext/yui/build/yahoo-dom-event/yahoo-dom-event.js"></script>
<script type="text/javascript" src="js-ext/yui/build/json/json-min.js"></script>
<script type="text/javascript" src="js-ext/yui/build/datatable/datatable.js"></script>
<script type="text/javascript" src="js-ext/yui/build/button/button.js"></script>
<script type="text/javascript" src="js-ext/yui/build/paginator/paginator-min.js"></script>
<script type="text/javascript" src="js-ext/yui/build/slider/slider-min.js"></script>
<!-- and this -->
<script type="text/javascript" src="js-ext/idle-timer.js"></script>
<script type="text/javascript" src="js-ext/YUI_DataTable_PasswordCellEditor.js"></script>
<script type="text/javascript" src="js-ext/YUI_DataTable_MD5CellEditor.js"></script>



<!-- Load Moment.js for parsing and formatting date/time -->
<script type="text/javascript" src="js-ext/moment.min.js"></script>
<link type="text/css" href="js-i2b2/cells/CRC/assets/query_report.css" rel="stylesheet" />

<style>
 @import url(assets/mod-treeview.css);
 @import url(assets/help_viewer.css);
 @import url(assets/msg_sniffer.css);
</style>

<!--  External libraries -->
<script type="text/javascript" src="js-ext/prototype.js"></script>
<script type="text/javascript" src="js-ext/firebug/firebugx.js"></script>
<script type="text/javascript" src="js-ext/excanvas.js"></script>
<script src="js.cookie.js"></script>
<script src="login.js"></script>

<style>

.myAccordion .yui-cms-accordion .yui-cms-item .bd .fixedbody {
	background: none repeat scroll 0 0 #FFFFFF;
	border: 1px solid #667788;
	padding: 1px 5px;
	height: 245px;
}
</style>

<!-- Graphics Libraries (only work in IE9 and above) -->
<!-- Load d3.js -->
<script type="text/javascript" src="js-ext/d3code/d3.v3.js"></script>
<!-- Load c3.js and stylesheet -->
<link href="js-ext/c3code/c3.css" rel="stylesheet" type="text/css">
<script src="js-ext/c3code/c3.js"></script>
<!-- Load jquery code and turn off $ -->
<link rel="stylesheet" type="text/css" href="assets/jquery.qtip.min.css" />

<script src="js-ext/jquerycode/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="js-ext/jquery.qtip.min.js"></script>

<!-- JQWidgets -->
<link rel="stylesheet" href="jqwidgets/styles/jqx.base.css" type="text/css" />
	<!--<script type="text/javascript" src="scripts/jquery-1.11.1.min.js"></script>-->
	<!--<script type="text/javascript" src="scripts/demos.js"></script>-->
<script type="text/javascript" src="jqwidgets/jqxcore.js"></script>
<script type="text/javascript" src="jqwidgets/jqxbuttons.js"></script>
<script type="text/javascript" src="jqwidgets/jqxscrollbar.js"></script>
<script type="text/javascript" src="jqwidgets/jqxtextarea.js"></script>
<script type="text/javascript" src="jqwidgets/jqxpanel.js"></script>
<script type="text/javascript" src="jqwidgets/jqxtree.js"></script>
<script type="text/javascript" src="jqwidgets/jqxexpander.js"></script>

<script>

        function loadTreeChildren($element, loaderItem, level) {
                        var t = i2b2.ONT.view.nav.params;
                        var options = {};
                        options.ont_hidden_records = t.hiddens;
                        options.ont_max_records = "max='"+t.max+"' ";
                        options.ont_synonym_records = t.synonyms;
                        options.ont_patient_count = t.patientCount;
                        options.ont_short_tooltip = t.shortTooltip;
                        options.ont_show_concept_code = t.showConceptCode;
                        options.concept_key_value = tree.jqxTree('getItem', $element[0]).value; // this should be the parent C_FULLNAME
                        options.version = i2b2.ClientVersion;
                        i2b2.ONT.ajax.GetChildConcepts("ONT:SDX:Concept", options, function (result) {
                                if(result.error) {
                                        alert("Error: " + result.error);
                                        return;
                                }
                            var c = result.refXML.getElementsByTagName('concept');
                            var names = [];
                            for(var i=0;i<1*c.length;i++) {
                                names.push({label: i2b2.h.getXNodeVal(c[i],'name'), value: i2b2.h.getXNodeVal(c[i],'key'), items: [{ label: "Loading..."}]});
                            }
                            tree.jqxTree('addTo', names, $element[0]);
                            tree.jqxTree('removeItem', loaderItem.element);

			    if(level > 2)
			        return;

				// load all the subitems too (up to a certain level)
				var children = $element[0].find('ul:first').children();
				var childLoaderItem = null;
				var child = null;
		                jQuery.each(children, function () {
				    child = this;
		                    var item = tree.jqxTree('getItem', this);
		                    if (item && item.label == 'Loading...') {
		                        childLoaderItem = item;
		                        return flase;
		                    }
                		});
				jQuery.each(children, function() {
					loadTreeChildren(child, childLoaderItem, level+1);
				});
                        });
        }

$(document).ready(function() {
	var $ = jQuery;
        $("#loginBtn").jqxButton({ width: 60, height: 24 });
        $("#loginBtn").on('click', function ()
            {
                $user = $("#loginUser").val();
                $pw = $("#loginPass").val();
		//alert($user + ", " + $pw);
		i2b2.PM.udlogin.inputUser.value = $user;
		i2b2.PM.udlogin.inputPass.value = $pw;
		i2b2.PM.doLogin();
            });
        $("#logoutBtn").jqxButton({ width: 60, height: 24 });
        $("#logoutBtn").on('click', function ()
            {
                i2b2.PM.doLogout();
            });

            var quotes = [];
            quotes.push('Life is a dream for the wise, a game for the fool, a comedy for the rich, a tragedy for the poor.');
            quotes.push('Yesterday is not ours to recover, but tomorrow is ours to win or lose.');
            quotes.push('It does not matter how slowly you go as long as you do not stop.');
            quotes.push('Success depends upon previous preparation, and without such preparation there is sure to be failure.');
            quotes.push('Better a diamond with a flaw than a pebble without.');
            quotes.push('To succeed in life, you need two things: ignorance and confidence.');
            quotes.push('A successful man is one who can lay a firm foundation with the bricks others have thrown at him.');
            quotes.push('Sleep is the best meditation.');
            $('#ontText').jqxTextArea({ placeHolder: 'Enter a sentence', height: 90, width: 300, minLength: 1, source: quotes });

// Create jqxExpander
            $('#jqxExpander').jqxExpander({ showArrow: false, toggleMode: 'none', width: '300px', height: '400px'});
	    tree = $('#jqxTree'); 
            tree.jqxTree({ width: '100%', height: '100%'});
            tree.jqxTree('selectItem', null);
	    tree.on('expand', function (event) {
                var label = tree.jqxTree('getItem', event.args.element).label;
                var $element = $(event.args.element);
                var startload = false;
                var loaderItem = null;
                var children = $element.find('ul:first').children();
                $.each(children, function () {
                    var item = tree.jqxTree('getItem', this);
                    if (item && item.label == 'Loading...') {
                        loaderItem = item;
                        startload = true;
                        return false
                    };
                });
                if (startload) {
			loadTreeChildren($element, loaderItem, 0);
                    }
            });

	// Log in?
	var loginStatus = loggedIn();
	if(loginStatus) {
		$("#loggedIn").show();
		$("#notLoggedIn").hide();
	}
	else {
                $("#loggedIn").hide();
                $("#notLoggedIn").show();
	}



 var $j = $.noConflict();
});

 var $j = $.noConflict();
// Code that uses other library's $ can follow here.

</script>

<!-- load i2b2 framework -->
<script type="text/javascript" src="js-i2b2/i2b2_loader.js"></script>
<link type="text/css" href="assets/i2b2.css" rel="stylesheet" />
<link type="text/css" href="assets/i2b2-NEW.css" rel="stylesheet" />

<!-- other auxiliary javascript source files -->
<script type="text/javascript" src="js-i2b2/hive/hive.ui.js"></script>
<script type="text/javascript">

function initI2B2() 
{
	//debugOnScreen("default.htm.initI2B2: browserViewPort = " + initBrowserViewPortDim.width + " " + initBrowserViewPortDim.height );
	i2b2.events.afterCellInit.subscribe(
		(function(en,co,a) {
			var cellObj = co[0];
			var cellCode = cellObj.cellCode;
			switch (cellCode) {
				case "PM":
					// This i2b2 design implementation uses a prebuild login DIV we connect the Project Management cell to
					// handle this method of login, the other method used for login is the PM Cell's built in floating
					// modal dialog box to prompt for login credentials.  You can edit the look and feel of this dialog box
					// by editing the CSS file.  You can remark out the lines below with no ill effect.  Use the following
					// javascript function to display the modal login form: i2b2.hive.PM.doLoginDialog();
					//cellObj.doConnectForm($('loginusr'),$('loginpass'),$('logindomain'), $('loginsubmit'));
					i2b2.PM.doLoginDialog();
					$("i2b2_login_modal_dialog").hide();
					break;
			}
		})
	);


	i2b2.events.afterHiveInit.subscribe(
		(function(ename) {
			// Misc GUI actions that need to be done after loading
			$('QPD1').style.background = '#FFFFFF';
			$('queryBalloon1').style.display = 'block';
		})
	);

	i2b2.events.afterLogin.subscribe(
		(function() 
		{
			//alert("AfterLogin");
                        i2b2.ONT.ctrlr.gen.events.onDataUpdate.subscribe(
                                (function(en,co) {
                                        console.group("[EVENT CAPTURED i2b2.ONT.ctrlr.gen.events.onDataUpdate]");
                                        console.dir(co[0]);
                                        var dm_loc = co[0].DataLocation;
                                        var dm_ptr = co[0].DataRef;
                                        if (dm_loc=='i2b2.ONT.model.Categories') {
                                                console.debug("Processing Category update");
                                                //i2b2.ONT.view.nav.PopulateCategories();
                                        }
                                        console.groupEnd();
					//alert("onDataUpdate");
		                        // Update Terminology Browser
		                        for(var i=0; i<1*i2b2.ONT.model.Categories.length; i++) {
		                                jQuery("#jqxTree").jqxTree("addTo", { label: i2b2.ONT.model.Categories[i].name, value: i2b2.ONT.model.Categories[i].key, items: [{ label: "Loading..."}]});
		                        }

                                })
                        );

			// after successful login hide the login box and display the application GUI
			$('topBar').style.display = 'block';
			$('screenQueryData').style.display = 'block';
			var splitterName = 'main.splitter';			
			
			// update dimension values
			initBrowserViewPortDim = document.viewport.getDimensions();
			rightSideWidth = initBrowserViewPortDim.width * rightSideProportion; 	// this component will take up 60% of the screen

			if (i2b2.PM.model.admin_only)
			{
				i2b2.hive.MasterView.setViewMode('Admin');
				$('viewMode-Patients').style.display = 'none';
				$('viewMode-Analysis').style.display = 'none';
				if(typeof i2b2.PM.model.installer_path !== "undefined"){
					$('adminPlugins').show();
				}
				// hide the splitter from view since we don't need it in admin-only mode
				var splitter = $( splitterName );
				splitter.style.visibility="hidden";
			} 
			else 
			{
				// create the splitter object only after login and not in admin-only mode
				i2b2.hive.mySplitter = new Splitter(splitterName, {cont: 'screenQueryData'});
				i2b2.hive.MasterView.initViewMode(); //tdw9
				
				jQuery('#pluginsMenu').qtip({
					content: {
						text: jQuery('#PluginListBox')
					},
					style: {
						width:500
					},
					show: 'click',
					position: {
						my: 'top right',  // Position my top left...
						at: 'bottom left', // at the bottom right of...
					},
					hide: 'unfocus click'

				});
				i2b2.PLUGINMGR.view.list.BuildCategories();
				i2b2.PLUGINMGR.view.list.Render();
				
			}
			$('viewMode-Project').innerHTML = "Project: " + i2b2.PM.model.login_projectname;
			$('viewMode-User').innerHTML = "User: " + i2b2.PM.model.login_fullname;
			$('viewMode-User').title = i2b2.PM.model.userRoles;
			if (i2b2.PM.model.otherAuthMethod) { $('changePasswordLink').hide(); }
			if (i2b2.PM.model.login_debugging) { $('debugMsgSniffer').show(); }
			if(typeof i2b2.PM.model.installer_path !== "undefined"){
				$('PluginGalleryFooter').show();
			}
			if (i2b2.PM.model.isAdmin){
				$('PluginsGalleryLink').innerHTML = "Click here to install plugins from i2b2 Gallery...";
			}

		}), i2b2
	);

	// start the i2b2 framework
	i2b2.Init();
}

function init() {
	// ------------------------------------------------------
	// put any pre-i2b2 initialization code here
	// ------------------------------------------------------

	// initialize the i2b2 framework
	initI2B2();
}
</script>
</head>
<body onload="init();" class='default'>

<div id="loginStatus">
	<span id="loggedIn">You are logged in.</span>
	<span id="loggedOut">You are not logged in.</span>
</div>

<div style="display:none;">
<!-- needed by hive -->
<div class="pageMask" id="topMask" style="display:none;">&nbsp;</div>

<!-- pluglstZoomImg needed by pluginmgr -->
<a href="JavaScript:i2b2.PLUGINMGR.view.list.ZoomView();"><img id="pluglstZoomImg" width="16" height="16" border="0" src="js-i2b2/cells/CRC/assets/zoom_icon.gif" alt="Resize Workspace" /></a>
<!-- plugviewZoomImg needed by pluginmgr -->
<a href="JavaScript:i2b2.PLUGINMGR.view.PlugView.showOptions();"><img src="assets/images/options.gif" border="0" width="16" height="16" alt="Show Options" title="Show Options" /></a> <a href="JavaScript:i2b2.PLUGINMGR.ctrlr.main.ZoomView();"><img id="plugviewZoomImg" width="16" height="16" border="0" src="js-i2b2/cells/PLUGINMGR/assets/zoom_icon.gif" alt="Resize Workspace" title="Resize Workspace" /></a>

<!-- needed by CRC -->
<div id="crcHistoryBox" style="display:none;"></div>
<!-- needed by CRC -->
<div style="border: 1px solid rgb(171, 173, 179); height:100px; overflow:auto; margin-left: 50px; width: 275px; padding: 4px" id="dialogQryRunResultType"></div>

</div>

<!-- keep this -->
<a href="JavaScript:showXML('PLUGINMGR','PlugView','Stack');" class="debug"><img src="assets/images/msg_stack.gif" border="0" width="16" height="16"  alt="Show XML Message Stack" title="Show XML Message Stack" /></a>

<!-- instantiate ontology widget -->
<!--<div id="screenQueryData" style="display:none">
  <div id="ontMainBox" style="display:none">
    <div id="ontMainDisp">
      <div id="ontNavDisp">
        <div id="ontNavResults"></div>
      </div>
    </div>
  </div>
</div>-->

<div style="text-align: center; margin-top: 25%;">
    <strong>Username:</strong> <input type="text" id="loginUser" label="Username:"/><br/>
    <strong>Password:</strong> <input type="password" id="loginPass" label="Password:"/>

    <div>
        <input style='margin-top: 20px;' type="submit" value="Login" id='loginBtn' />
        <input style='margin-top: 20px;' type="submit" value="Logout" id='logoutBtn' />
    </div>
</div>

<div>
<textarea id="ontText"></textarea>
</div>

    <div id='jqxWidget'>
        <div id='jqxExpander'>
            <div>
                Browse Categories
            </div>
            <div style="overflow: hidden;">
                <div style="border: none;" id='jqxTree'>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
